# Upgrade from v1.10.x to v2.0.0

In version 2.0.0 of `fury-eks-installer`, we split the vpc-and-vpn module in two, to allow the creation of a VPC and VPN separately, as the latter became optional with the introduction of public EKS clusters.
We also added the possibility to configure the ability to access the Kubernetes API endpoint privately, publicly or both.

## Migrate from the old vpc-and-vpn module to the new vpc and vpn modules

Enter the infrastructure directory

```sh
cd /path/to/infrastructure
```

If you have the terraform state stored locally, make a backup of it

```sh
cp bootstrap/terraform.tfstate ./terraform.tfstate.bak
```

Reset the bootstrap directory

```sh
furyctl bootstrap init --reset
```

If you have the terraform state stored locally, restore it

```sh
mv ./terraform.tfstate.bak bootstrap/terraform.tfstate
```

Dry-run the apply subcommand to regenerate the terraform variables

```sh
furyctl bootstrap apply --dry-run
```

Enter the bootstrap directory

```sh
cd ./bootstrap
```

Verify the plan, you will see there are several changes

```sh
bin/terraform plan -input=false -refresh=true -lock=false -var-file=aws.tfvars
```

Start moving the state to match the new modules

```sh
terraform state mv module.vpc-and-vpn.module.vpc.aws_eip.nat[0] module.vpc[0].module.vpc.aws_eip.nat[0]
terraform state mv module.vpc-and-vpn.module.vpc.aws_internet_gateway.this[0] module.vpc[0].module.vpc.aws_internet_gateway.this[0]
terraform state mv module.vpc-and-vpn.module.vpc.aws_nat_gateway.this[0] module.vpc[0].module.vpc.aws_nat_gateway.this[0]
terraform state mv module.vpc-and-vpn.module.vpc.aws_route_table_association.private[0] module.vpc[0].module.vpc.aws_route_table_association.private[0]
terraform state mv module.vpc-and-vpn.module.vpc.aws_route_table_association.private[1] module.vpc[0].module.vpc.aws_route_table_association.private[1]
terraform state mv module.vpc-and-vpn.module.vpc.aws_route_table_association.private[2] module.vpc[0].module.vpc.aws_route_table_association.private[2]
terraform state mv module.vpc-and-vpn.module.vpc.aws_route_table_association.public[0] module.vpc[0].module.vpc.aws_route_table_association.public[0]
terraform state mv module.vpc-and-vpn.module.vpc.aws_route_table_association.public[1] module.vpc[0].module.vpc.aws_route_table_association.public[1]
terraform state mv module.vpc-and-vpn.module.vpc.aws_route_table_association.public[2] module.vpc[0].module.vpc.aws_route_table_association.public[2]
terraform state mv module.vpc-and-vpn.module.vpc.aws_route_table.private[0] module.vpc[0].module.vpc.aws_route_table.private[0]
terraform state mv module.vpc-and-vpn.module.vpc.aws_route_table.public[0] module.vpc[0].module.vpc.aws_route_table.public[0]
terraform state mv module.vpc-and-vpn.module.vpc.aws_route.private_nat_gateway[0] module.vpc[0].module.vpc.aws_route.private_nat_gateway[0]
terraform state mv module.vpc-and-vpn.module.vpc.aws_route.public_internet_gateway[0] module.vpc[0].module.vpc.aws_route.public_internet_gateway[0]
terraform state mv module.vpc-and-vpn.module.vpc.aws_subnet.private[0] module.vpc[0].module.vpc.aws_subnet.private[0]
terraform state mv module.vpc-and-vpn.module.vpc.aws_subnet.private[1] module.vpc[0].module.vpc.aws_subnet.private[1]
terraform state mv module.vpc-and-vpn.module.vpc.aws_subnet.private[2] module.vpc[0].module.vpc.aws_subnet.private[2]
terraform state mv module.vpc-and-vpn.module.vpc.aws_subnet.public[0] module.vpc[0].module.vpc.aws_subnet.public[0]
terraform state mv module.vpc-and-vpn.module.vpc.aws_subnet.public[1] module.vpc[0].module.vpc.aws_subnet.public[1]
terraform state mv module.vpc-and-vpn.module.vpc.aws_subnet.public[2] module.vpc[0].module.vpc.aws_subnet.public[2]
terraform state mv module.vpc-and-vpn.module.vpc.aws_vpc.this[0] module.vpc[0].module.vpc.aws_vpc.this[0]

terraform state mv module.vpc-and-vpn.aws_eip_association.vpn[0] module.vpn[0].aws_eip_association.vpn[0]
terraform state mv module.vpc-and-vpn.aws_eip.vpn[0] module.vpn[0].aws_eip.vpn[0]
terraform state mv module.vpc-and-vpn.aws_iam_access_key.furyagent module.vpn[0].aws_iam_access_key.furyagent
terraform state mv module.vpc-and-vpn.aws_iam_policy_attachment.furyagent module.vpn[0].aws_iam_policy_attachment.furyagent
terraform state mv module.vpc-and-vpn.aws_iam_policy.furyagent module.vpn[0].aws_iam_policy.furyagent
terraform state mv module.vpc-and-vpn.aws_iam_user.furyagent module.vpn[0].aws_iam_user.furyagent
terraform state mv module.vpc-and-vpn.aws_instance.vpn[0] module.vpn[0].aws_instance.vpn[0]
terraform state mv module.vpc-and-vpn.aws_s3_bucket.furyagent module.vpn[0].aws_s3_bucket.furyagent
terraform state mv module.vpc-and-vpn.aws_security_group_rule.vpn module.vpn[0].aws_security_group_rule.vpn
terraform state mv module.vpc-and-vpn.aws_security_group_rule.vpn_egress module.vpn[0].aws_security_group_rule.vpn_egress
terraform state mv module.vpc-and-vpn.aws_security_group_rule.vpn_ssh module.vpn[0].aws_security_group_rule.vpn_ssh
terraform state mv module.vpc-and-vpn.aws_security_group.vpn module.vpn[0].aws_security_group.vpn
terraform state mv module.vpc-and-vpn.local_file.furyagent module.vpn[0].local_file.furyagent
terraform state mv module.vpc-and-vpn.local_file.sshkeys module.vpn[0].local_file.sshkeys
terraform state mv module.vpc-and-vpn.null_resource.init module.vpn[0].null_resource.init
terraform state mv module.vpc-and-vpn.null_resource.ssh_users module.vpn[0].null_resource.ssh_users
```

Verify the plan once again, making sure the changes that will be applied are safe.

```sh
bin/terraform plan -input=false -refresh=true -lock=false -var-file=aws.tfvars
```

Clean up terraform state backups, once you are sure that the state has been migrated successfully.

```sh
rm terraform.tfstate.*.backup
```

Go back to the infrastructure folder and apply the bootstrap phase:

```sh
cd ..
furyctl bootstrap apply
```

Verify the plan one last time, to make sure all the changes were applied and no more changes are pending.

```sh
cd bootstrap
bin/terraform plan -input=false -refresh=true -lock=false -var-file=aws.tfvars
```
